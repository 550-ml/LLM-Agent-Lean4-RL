0. 概述：我们要实现什么？

为贴合论文《Hilbert: Recursively Building Formal Proofs with Informal Reasoning》以及附录 PDF 中的算法，本仓库需要围绕统一的输入协议（head + problem）与五大 Agent 的职责来实现递归 Lean4 证明系统。以下文档用于指导后续开发与对齐。

1. 输入规范（Head + Problem）

- head：题目编号、来源、年份、难度等元信息，用于检索、提示词个性化以及日志追踪。
- problem：Lean4 任务模板，通常包含 theorem/lemma 声明和 by 证明骨架。
- 要求：所有 Agent 的提示词、状态体和日志都要同时持有 head 与 problem，Coordinator 在递归派发子任务时也必须附带两者。

2. Reasoner Agent（通用 LLM）

- 数学理解（附录 1.1）：解析 problem + head，抽取主要对象、关键概念、问题类型等结构化信息。
- 非形式证明（附录 1.2）：基于理解输出自然语言策略、关键步骤和可能使用的引理。
- Proof Sketch（附录 1.3）：将非形式证明转为 Lean4 骨架，逐个 have hi : ... := by sorry，保持逻辑依赖并在末尾组合主结论。
- Shallow Solve（附录 1.4）：对显然子目标尝试 simp, rfl, trivial 等快速战术；若复杂则返回占位（如 COMPLEX）交给后续流程。
- 所有提示词需引用 head 信息（如 Putnam 2012 A1）与 problem 片段，保证上下文一致。

3. Prover Agent（Lean LLM）

- 输入：Proof Sketch 中的单个 have ... := by sorry、当前 Lean 上下文（含 head/问题描述、已证明引理、检索到的定理）以及错误历史。
- 功能：生成完整 Lean 代码替换 by sorry，不允许再次留空。
- 工程要点：子目标提取 _extract_subgoals、错误累积 error_history、证明回填 _assemble_proof，全部逻辑与附录第 2 节一致。

4. Verifier（Lean4 Runner）

- 基础：沿用 src/verifier/lean4_runner.py 的整体验证能力。
- 增强：实现 verify_subgoal（拼接 context+子目标后单独编译）与 extract_unsolved_subgoals（从 Lean 报错文本中抓取遗留 have ... := by sorry），对应附录 3.1 / 3.2。
- 输出：Lean 编译结果、错误类型、剩余 goals，供 Coordinator 决策。

5. Retriever（语义检索）

- 定理库 src/retriever/theorem_db.py：从 mathlib 或 data/benchmarks/lean4 中提取 theorem/lemma，生成 embedding 索引。
- 检索 src/retriever/retriever_agent.py：以 head+problem 或 Reasoner 的概念摘要为查询，返回 top-k 候选引理（含 name/statement/score）。
- 结果：写入 Reasoner/Prover 的 prompt context，在 Proof Sketch 中可显式引用。

6. Coordinator（调度器）

- 主流程：solve(head, problem) → Retriever → Reasoner（理解/非形式/Sketch）→ 子目标提取 → 对每个子目标执行「shallow_solve → 递归 _solve_recursive → Prover → Verifier」→ 组装 → 最终验证。
- 关键机制：子目标缓存（哈希 goal）、最大递归深度、失败重试（记录 error_history）、状态传递（head+problem+context）。
- 输出：完整 Lean 证明及验证结果，若失败需返回错误栈，方便上层重试或人工排查。

7. 实施顺序（对应附录 Checklist）

1. Reasoner 四模块 + prompt。
2. Prover 子目标证明与回填。
3. Verifier 子目标验证与未解子目标解析。
4. Retriever 定理库与语义检索。
5. Coordinator 递归调度、缓存、重试整合。
6. 配置：在 config/default.yaml 中开启 retriever/coordinator 相关开关；在 data/prompts 中更新 head+problem 版提示词。
7. 测试：先做模块级单测，再运行端到端样例（含 head+problem 输入）验证 Reasoner→Coordinator→Verifier 闭环。

严格遵循上述输入规范与职责划分，即可按附录 PDF 的算法实现完整的 HILBERT 递归求证系统。
